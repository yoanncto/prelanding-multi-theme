<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title  ">Offer Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="translations/translations.js"></script>
    <script src="js/currency-formatter.js"></script>
    <script src="themes/theme-manager.js" defer></script>
    <script src="js/checkout-handler.js" defer></script>
    <style>
        /* Common styles for all themes */
        .prime-badge {
            background: linear-gradient(135deg, #00A8E1 0%, #0077C2 100%);
        }
        
        .amazon-button {
            background: linear-gradient(to bottom, #f8e3ad 0%, #EEBA37 100%);
            border-color: #c89411;
        }
        .amazon-button:hover {
            background: linear-gradient(to bottom, #f5d78e 0%, #eeb933 100%);
        }
        
        .ebay-button {
            background: #0063D1;
        }
        .ebay-button:hover {
            background: #004998;
        }
        
        .shopify-button {
            background: linear-gradient(to bottom, #008060 0%, #004C3F 100%);
        }
        .shopify-button:hover {
            background: linear-gradient(to bottom, #004C3F 0%, #002E25 100%);
        }

        /* Animation styles */
        .fade-out {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .fade-in {
            opacity: 0;
            transform: scale(0.95);
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Improved result section animations */
        #resultSection {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #resultSection.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* Improved scratch game animations */
        .reveal-cover {
            background: linear-gradient(135deg, #232F3E 30%, #37475A 100%);
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        .reveal-cover:hover {
            background: linear-gradient(135deg, #37475A 30%, #232F3E 100%);
        }
        .reveal-cover.revealed {
            opacity: 0;
            pointer-events: none;
        }
        .reveal-cover .content {
            transition: all 0.3s ease;
        }
        .reveal-cover:hover .content {
            transform: scale(1.05);
        }
        
        /* Game content animations */
        #gameContent {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #gameContent.fade-out {
            opacity: 0;
            transform: scale(0.9);
        }
        
        /* Game overlay animations */
        #gameOverlay {
            transition: opacity 0.3s ease;
        }
        #gameOverlay.fade-in {
            animation: overlayFadeIn 0.3s ease forwards;
        }
        @keyframes overlayFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        /* Game-specific styles */
        .slot-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .slot {
            background: #232F3E;
            width: 60px;
            height: 60px;
            border-radius: 0.5rem;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        .spinning {
            animation: spin 0.6s infinite linear;
        }
        @keyframes spin {
            0% { transform: translateY(0); }
            25% { transform: translateY(-10px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }

        .box {
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .box:hover {
            transform: scale(1.05);
            background-color: #37475A;
        }
    </style>
</head>
<body class="bg-white text-gray-900 font-sans">
    <div id="content"></div>

    <script>
        console.log('Index script starting');
        
        async function initPage() {
            try {
                console.log('Initializing page');
                
                // Wait for ThemeManager to be ready (it parses params internally now)
                await new Promise(resolve => {
                     const checkTM = () => {
                         if (window.themeManager) {
                             console.log("ThemeManager ready.");
                             resolve();
                         } else {
                              console.log("Waiting for ThemeManager...");
                             setTimeout(checkTM, 50);
                         }
                     };
                     checkTM();
                });

                const productParams = window.themeManager.productParams; // Get params from ThemeManager

                // --- URL Cleaning and Base Tag Setup (Simplified) ---
                const currentUrl = new URL(window.location.href);
                const originalPath = currentUrl.pathname;
                const basePath = originalPath.substring(0, originalPath.lastIndexOf('/') + 1);
                const cleanPath = basePath.endsWith('/') && basePath.length > 1 ? basePath : '/';

                window.history.replaceState(
                    { basePath: basePath },
                    document.title,
                     currentUrl.origin + (cleanPath === '/' ? '' : cleanPath)
                );
                console.log(`URL cleaned. Base path kept: ${basePath}`);

                const baseTag = document.createElement('base');
                baseTag.href = currentUrl.origin + basePath;
                const existingBase = document.querySelector('base');
                if (existingBase) existingBase.remove();
                document.head.prepend(baseTag);
                console.log('Base tag set to:', baseTag.href);
                // --- End URL Cleaning ---

                // --- Favicon Setup ---
                const faviconLink = document.createElement('link');
                faviconLink.rel = 'icon';
                faviconLink.href = `assets/${productParams.theme}favicon.ico`;
                faviconLink.type = 'image/x-icon';
                document.querySelectorAll("link[rel='icon']").forEach(link => link.remove());
                document.head.appendChild(faviconLink);
                console.log('Favicon set to:', faviconLink.href);
                 // --- End Favicon Setup ---

                // --- Translations Setup ---
                 if (window.i18n && typeof window.i18n.init === 'function' && !window.i18n.translations) {
                     console.log('Initializing and waiting for translations...');
                      await new Promise((resolve, reject) => {
                          const checkTranslations = () => {
                              if (window.i18n.translations) {
                                  console.log('Translations loaded.');
                                  resolve();
                              } else {
                                  setTimeout(checkTranslations, 50);
                              }
                          };
                          if (!window.i18n.isInitialized) {
                               window.i18n.init().then(checkTranslations).catch(err => {
                                   console.error("Translation init failed:", err);
                                   resolve(); // Continue anyway
                               });
                          } else {
                               checkTranslations();
                          }
                      });
                 } else {
                      console.log('Translations seem ready or i18n object not configured as expected.');
                 }
                  // --- End Translations Setup ---

                // Load the initial game template
                const template = await window.themeManager.loadGameTemplate();
                const contentDiv = document.getElementById('content');

                if (template && contentDiv) {
                    console.log('Initial game template loaded, length:', template.length);
                    contentDiv.innerHTML = template;
                    console.log('Initial game template inserted into DOM');

                    // Placeholder replacement is now handled inside themeManager._fetchAndProcessTemplate
                    // Initialize game-specific scripts AFTER template insertion
                    initializeGameScripts(productParams.game, productParams);
                    console.log('Game scripts initialization requested for:', productParams.game);

                    // Apply translations
                    if (window.i18n && typeof window.i18n.updatePageTranslations === 'function') {
                        console.log('Applying translations to initial content');
                        window.i18n.updatePageTranslations(contentDiv);
                         updatePageTitle(productParams);
                    }
                } else {
                    console.error('Initial game template failed to load or #content not found');
                    if(contentDiv) contentDiv.innerHTML = '<p class="text-center text-red-600 p-8">Error loading content. Please try refreshing the page.</p>';
                }
            } catch (error) {
                console.error('Critical Error initializing page:', error);
                 const contentDiv = document.getElementById('content');
                 if(contentDiv) contentDiv.innerHTML = '<p class="text-center text-red-600 p-8">An unexpected error occurred. Please try refreshing the page.</p>';
            }
        }

        // Placeholder replacement function (can be used by themeManager)
        window.replacePlaceholders = function(params, containerElement) {
            if (!containerElement) {
                 console.warn("replacePlaceholders called without containerElement");
                 return;
            }
            console.log('Running replacePlaceholders for container:', containerElement.id || containerElement.tagName);

            const price = window.currencyFormatter?.format(params.price) || params.price;
            const retailPrice = window.currencyFormatter?.format(params.retailPrice) || params.retailPrice;
            // Note: checkoutLink with px param is handled better in themeManager/checkoutHandler now
            const checkoutLinkForData = params.checkoutLink || '#'; // Raw link for potential data attributes

            const replacements = {
                '{PRODUCT_NAME}': params.productName,
                '{PRODUCT_PRICE}': price,
                '{PRODUCT_RETAIL_PRICE}': retailPrice,
                '{PRODUCT_IMAGE}': params.productImage,
                // We don't replace {CHECKOUT_LINK} directly in hrefs anymore
            };

            const walker = document.createTreeWalker(containerElement, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null, false);
            let node;
            const nodesToProcess = [];
            while(node = walker.nextNode()) {
                nodesToProcess.push(node);
            }

             nodesToProcess.forEach(node => {
                 if (node.nodeType === Node.TEXT_NODE) {
                     let originalValue = node.nodeValue;
                     Object.keys(replacements).forEach(key => {
                         if (originalValue.includes(key)) {
                             // Correctly escaped RegExp
                             originalValue = originalValue.replace(new RegExp(key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replacements[key]);
                             node.nodeValue = originalValue;
                         }
                     });
                 } else if (node.nodeType === Node.ELEMENT_NODE) {
                     // Replace in text content of specific data attributes (like data-product-name)
                     Object.keys(node.dataset).forEach(dataKey => {
                          let value = node.dataset[dataKey];
                          Object.keys(replacements).forEach(key => {
                              if(value === key) { // Check if data attribute value IS the placeholder
                                  // Replace the element's text content, not the data attribute itself
                                  if(node.textContent.includes(key)) {
                                      node.textContent = node.textContent.replace(key, replacements[key]);
                                      console.log(`Replaced text for data attribute ${dataKey} on`, node);
                                  }
                              } else if (value.includes(key)) { // Replace within data attribute value if needed
                                    // Correctly escaped RegExp
                                    node.dataset[dataKey] = value.replace(new RegExp(key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replacements[key]);
                              }
                          });
                     });

                     // Replace in specific attributes like src
                     if (node.tagName === 'IMG' && node.getAttribute('src')?.includes('{PRODUCT_IMAGE}')) {
                         node.src = replacements['{PRODUCT_IMAGE}'];
                     }
                      // Replace in anchor href if it explicitly uses a placeholder (less common now)
                      if (node.tagName === 'A' && node.getAttribute('href')?.includes('{CHECKOUT_LINK}')) {
                          console.warn("Found direct {CHECKOUT_LINK} in href, replacing but prefer data attributes or JS handling:", node);
                          node.href = checkoutLinkForData; // Use raw link
                      }
                 }
             });
             console.log('Placeholder replacement finished for container.');
         }

        function initializeGameScripts(gameType, params) {
            if (!gameType) {
                console.warn("No game type specified, cannot initialize game scripts.");
                 // Potentially load a default display or error message
                 const contentDiv = document.getElementById('content');
                 if(contentDiv) contentDiv.innerHTML += '<p class="text-center text-yellow-600 p-4">No game selected.</p>';
                return;
            }

            document.querySelectorAll('script[data-game-script]').forEach(script => script.remove());

            const script = document.createElement('script');
            script.src = `js/games/${gameType}.js`;
            script.setAttribute('data-game-script', 'true');
            script.defer = true;

            script.onload = () => {
                console.log(`${gameType}.js loaded.`);
                if (typeof window.initializeGame === 'function') {
                     console.log(`Calling initializeGame() for ${gameType}.js`);
                     try {
                        window.initializeGame(params);
                        // NOTE: The final checkout button listener setup is removed from here.
                        // It should be triggered by the game logic itself when the result section is shown,
                        // OR handled within the window.loadCheckoutPage function implicitly.
                        // The crucial part is that the button in the template calls window.loadCheckoutPage().
                     } catch (error) {
                         console.error(`Error during initializeGame for ${gameType}:`, error);
                     }
                } else {
                    console.warn(`initializeGame function not found in ${gameType}.js`);
                }
            };
            script.onerror = (e) => {
                console.error(`Failed to load game script: ${script.src}`, e);
                 const contentDiv = document.getElementById('content');
                 if(contentDiv) contentDiv.innerHTML += '<p class="text-center text-red-500 p-4">Error loading game components.</p>';
            };
            document.body.appendChild(script);
        }

        function updatePageTitle(params) {
            const titleElement = document.querySelector('head title');
            if (titleElement) {
                const themeName = params.theme.charAt(0).toUpperCase() + params.theme.slice(1);
                // Use game name if available, otherwise just theme name
                const gameName = params.game ? params.game.charAt(0).toUpperCase() + params.game.slice(1) : '';
                const titleKey = `page_title.${params.theme}${params.game ? '.' + params.game : ''}`; // e.g., page_title.amazon.slot
                const defaultTitle = `${themeName}${gameName ? ' ' + gameName : ''} Offer`;
                titleElement.textContent = window.i18n?.getTranslation(titleKey) || defaultTitle;
                console.log("Page title updated to:", titleElement.textContent);
            }
        }

        // Initialize page on DOM ready
        if (document.readyState === 'loading') {
             document.addEventListener('DOMContentLoaded', initPage);
        } else {
             initPage();
        }
    </script>
</body>
</html> 